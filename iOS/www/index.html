<!DOCTYPE html>
<html>
  <head>
    <title>Capture Photo</title>
    
    <style type="text/css">
    	body {font-family: arial,sans-serif;}
    	button { width:100%; size:200%; }
    	canvas { margin:0px auto; }
        .hidden { display:none; }
    </style>

    <script type="text/javascript" charset="utf-8" src="cordova-1.8.0.js"></script>
    <script src="http://10.92.16.171:8080/target/target-script-min.js#anonymous"></script>
    <script type="text/javascript" charset="utf-8" src="ntc2.js"></script>
    <script type="text/javascript">
function rgb2hsl(r, g, b){
    r /= 255, g /= 255, b /= 255;
    var max = Math.max(r, g, b), min = Math.min(r, g, b);
    var h, s, l = (max + min) / 2;

    if(max == min){
        h = s = 0; // achromatic
    }else{
        var d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch(max){
            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
            case g: h = (b - r) / d + 2; break;
            case b: h = (r - g) / d + 4; break;
        }
        h /= 6;
    }

    return [h, s, l];
}

function dec2hex(d) {
var n1 = d&15;
var n2 = (d&240)>>4;
return n2.toString(16)+n1.toString(16);
}

function rgb2html(r, g, b) {
return '#'+dec2hex(r)+dec2hex(g)+dec2hex(b);
}

function hsl2int(h, s, l) {
    var decColor = Math.floor(l*127) | ( Math.floor(s*127) << 7) | ( Math.floor(h*1023) << 14);
    return decColor;
}

function cmpLength(a,b) { 
return (b.length-a.length); }

function detectColour(place, data) {
var maxcol=256;
var maxhue=256;
var maxsat=256;
var maxlum=256;
var i,j,r,g,b;
var coldata= new Array();
var hsldata= new Array();
var sldata=  new Array();
var ldata= new Array();
for (i=0; i<maxcol; i++) { coldata[i]=new Array(); }
for (i=0; i<maxhue; i++) { hsldata[i]=new Array(); }
for (i=0; i<maxsat; i++) { sldata[i]=new Array(); }
for (i=0; i<maxlum; i++) { ldata[i]=new Array(); }

for (i=0; i<data.length; i+=4) {
var colour = rgb2html(data[i], data[i+1], data[i+2]);
    var n_match  = ntc.name(colour);
    alert(n_match);
    alert(coldata);
    if (coldata[n_match[3]] == undefined) {
        coldata.push(n_match[3]);
    }
    
    alert(coldata);
    coldata[n_match[3]].push(i);
}
coldata.sort(cmpLength);
var colplace=coldata[place];

for (i=0; i<colplace.length; i++) {
j=colplace[i];
var hsl=rgb2hsl(data[j], data[j+1], data[j+2]);
var hue=Math.floor(hsl[0]*(maxhue-1));
  hsldata[hue].push(j);
}
hsldata.sort(cmpLength);

for (i=0; i<hsldata[0].length; i++) {
j=hsldata[0][i];
var hsl=rgb2hsl(data[j], data[j+1], data[j+2]);
var sat=Math.floor(hsl[1]*(maxsat-1));
sldata[sat].push(j);
}
sldata.sort(cmpLength);

for (i=0; i<sldata[0].length; i++) {
var j=sldata[0][i];
var hsl=rgb2hsl(data[j], data[j+1], data[j+2]);
var lum=Math.floor(hsl[2]*(maxlum-1));
ldata[lum].push(j);
}
ldata.sort(cmpLength);

j=ldata[0][0];

r=data[j];
g=data[j+1];
b=data[j+2];

// painting all the similar colours with the calculated one...
for (i=0; i<colplace.length; i++) {
j=colplace[i];
data[j]=r;
data[j+1]=g;
data[j+2]=b;
}

var rgb=[r,g,b];
return rgb;
}

function detectColour2(data) {
var i;
var hsldata= new Array();
var sldata=  new Array();
var ldata= new Array();

for (i=0; i<256; i++) { 
hsldata[i]=new Array();
sldata[i]=new Array();
ldata[i]=new Array();
}

for (i=0; i<data.length; i+=4) {
var hsl=rgb2hsl(data[i], data[i+1], data[i+2]);
var lum=Math.floor(hsl[2]*255);
hsldata[lum].push(i);
}
hsldata.sort(cmpLength);

for (i=0; i<hsldata[0].length; i++) {
var j=hsldata[0][i];
var hsl=rgb2hsl(data[j], data[j+1], data[j+2]);
var hue=Math.floor(hsl[0]*255);
sldata[hue].push(j);
}
sldata.sort(cmpLength);

for (i=0; i<sldata[0].length; i++) {
var j=sldata[0][i];
var hsl=rgb2hsl(data[j], data[j+1], data[j+2]);
var sat=Math.floor(hsl[1]*255);
ldata[sat].push(j);
}
ldata.sort(cmpLength);

var j=ldata[0][0];
var rgb=[ data[j], data[j+1], data[j+2] ];
return rgb;
}


function draw(freshimage) {
 var orig = document.getElementById('canvas');
    var  ctx = orig.getContext('2d');
    var img = new Image();
    img.onload = function(){
    
    alert('onload start');
ctx.clearRect(0,0,orig.width,orig.height);
          ctx.drawImage(img, 0,0, orig.width, orig.height);
var imgd = ctx.getImageData(0, 0, orig.width, orig.height);
var data=imgd.data;
var pix =detectColour(0, data);
var colour = rgb2html(pix[0], pix[1], pix[2]);
    var n_match  = ntc.name(colour);
var hsl=rgb2hsl(pix[0], pix[1], pix[2]);
var hslint = hsl2int(hsl[0],hsl[1],hsl[2]);

document.bgColor = colour;
document.getElementById('width').value=img.width;
document.getElementById('height').value=img.height;
document.getElementById('red').value=pix[0];
document.getElementById('green').value=pix[1];
document.getElementById('blue').value=pix[2];
document.getElementById('bgcolor').value=colour;
document.getElementById('hslint').value= hslint;
var prefix = "";

var sat ='medium';
if (hsl[1]<0.3) {sat='weak'; prefix=sat+' ';}
else if (hsl[1]>0.7) {sat='strong';prefix=sat+' ';}
document.getElementById('sat').value=sat;

var lum ='medium';
if (hsl[2]<0.3) {lum='dark';prefix=prefix+lum+' ';}
else if (hsl[2]>0.7) {lum='light';prefix=prefix+lum+' ';}
document.getElementById('lum').value=lum;
document.getElementById('col').value=prefix+n_match[3] +'.\n'+ n_match[1];

for (i=1; i<2; i++) {
pix =detectColour(i, data);
colour = rgb2html(pix[0], pix[1], pix[2]);
n_match  = ntc.name(colour);
hsl=rgb2hsl(pix[0], pix[1], pix[2]);
prefix = "";
sat ='medium';
if (hsl[1]<0.3) {sat='weak'; prefix=sat+' ';}
else if (hsl[1]>0.7) {sat='strong';prefix=sat+' ';}
lum ='medium';
if (hsl[2]<0.3) {lum='dark';prefix=prefix+lum+' ';}
else if (hsl[2]>0.7) {lum='light';prefix=prefix+lum+' ';}
document.getElementById('col').value+="\n2nd Colour:\n"+colour+"\n"+prefix+n_match[3] +'.\n'+ n_match[1];
}

  document.getElementById('col').focus();
delete img;
    alert('end of imgload');
    }
    img.src = freshimage.src;
}
    
    
    
    
    
    
    

    var pictureSource;   // picture source
    var destinationType; // sets the format of returned value 

    document.addEventListener("deviceready",onDeviceReady,false);

    function onDeviceReady() {
        pictureSource=navigator.camera.PictureSourceType;
        destinationType=navigator.camera.DestinationType;
    }

    function onPhotoDataSuccess(imageData) {
    	//	navigator.notification.alert("win");
      var smallImage = document.getElementById('smallImage');
      // smallImage.style.display = 'block';
      smallImage.src = "data:image/jpeg;base64," + imageData;
      draw(smallImage);
    }


    function capturePhoto() {
        if (navigator.camera) {
            navigator.camera.getPicture(onPhotoDataSuccess, onFail, { quality: 25, destinationType: destinationType.DATA_URL });
        } else {
            console.log("phonegap camera not available");
        }
    }


    function onFail(message) {
    	//navigator.notification.alert("fail");
      alert('Failed because: ' + message);
    }

    </script>
    
  </head>
  <body>
    <button onclick="capturePhoto();">Capture Photo</button> <br>
    <img style="display:none;width:60px;height:60px;" id="smallImage" src="#" alt="" />
    
    <canvas id="canvas" width="240" height="320"></canvas>
    
    <img src="test-00.jpg" id="test-00" />
    
    <form id="image">



<input  onclick="draw(document.getElementById('test-00'));" type="button" name="submit1" value="Test colour 1" /><br/>


<label for="col">Colour:</label><br/>
<textarea name="col" id="col" cols="40" rows="3"></textarea>

<label for="bgcolor">bgcolor:</label>
<input type="text" name="bgcolor" id="bgcolor" value="" /><br/>

<label for="sat">Saturation:</label>
<input type="text" name="sat" id="sat" value="" /><br/>

<label for="lum">Brightness:</label>
<input type="text" name="lum" id="lum" value="" /><br/>




<label class="hidden" for="width">Width:</label>
<input class="hidden"  type="text" name="width" id="width" value="" /><br/>
<label class="hidden"  for="height">Height: </label>
<input class="hidden"  type="text" name="height" id="height" value="" /> <br/>

<label class="hidden"  for="red">red:</label>
<input class="hidden"  type="text" name="red" id="red" value="" /><br/>
<label class="hidden"  for="green">green:</label>
<input class="hidden"  type="text" name="green" id="green" value="" /><br/>
<label class="hidden"  for="blue">blue:</label>
<input class="hidden"  type="text" name="blue" id="blue" value="" /><br/>


<label class="hidden"  for="bgcolor">bgcolor:</label>
<input class="hidden"  type="text" name="bgcolor" id="bgcolor" value="" /><br/>

<label class="hidden"  for="hslint">HSL long integer:</label>
<input class="hidden"  type="text" name="hslint" id="hslint" value="" /><br/>




</form>
    
  </body>
</html>